//! Markdown report generation for benchmark results
//!
//! This module provides utilities to generate human-readable markdown
//! reports from benchmark results.

use super::result::BenchmarkResult;
use chrono::Utc;

/// Generate a markdown summary report from benchmark results.
///
/// # Arguments
///
/// * `results` - Vector of benchmark results
/// * `title` - Optional title for the report
///
/// # Returns
///
/// A formatted markdown string.
pub fn generate_markdown_report(results: &[BenchmarkResult], title: Option<&str>) -> String {
    let mut md = String::new();

    // Header
    md.push_str(&format!(
        "# {}\n\n",
        title.unwrap_or("Connector Hub Benchmark Results")
    ));
    md.push_str(&format!(
        "Generated: {}\n\n",
        Utc::now().format("%Y-%m-%d %H:%M:%S UTC")
    ));

    // Summary
    let total = results.len();
    let successful = results.iter().filter(|r| r.is_success()).count();
    let failed = total - successful;

    md.push_str("## Summary\n\n");
    md.push_str(&format!("| Metric | Value |\n"));
    md.push_str("|--------|-------|\n");
    md.push_str(&format!("| Total Benchmarks | {} |\n", total));
    md.push_str(&format!("| Successful | {} |\n", successful));
    md.push_str(&format!("| Failed | {} |\n", failed));
    md.push_str(&format!(
        "| Success Rate | {:.1}% |\n\n",
        (successful as f64 / total as f64) * 100.0
    ));

    // Detailed Results
    md.push_str("## Detailed Results\n\n");
    md.push_str("| Target | Status | Mean (ns) | P99 (ns) | Throughput (ops/s) |\n");
    md.push_str("|--------|--------|-----------|----------|--------------------|\n");

    for result in results {
        let status = if result.is_success() { "OK" } else { "FAIL" };
        let mean = result
            .mean_ns()
            .map(|v| format!("{}", v))
            .unwrap_or_else(|| "-".to_string());
        let p99 = result
            .p99_ns()
            .map(|v| format!("{}", v))
            .unwrap_or_else(|| "-".to_string());
        let throughput = result
            .throughput()
            .map(|v| format!("{:.2}", v))
            .unwrap_or_else(|| "-".to_string());

        md.push_str(&format!(
            "| {} | {} | {} | {} | {} |\n",
            result.target_id, status, mean, p99, throughput
        ));
    }

    md.push_str("\n");

    // Individual benchmark details
    md.push_str("## Benchmark Details\n\n");

    for result in results {
        md.push_str(&format!("### {}\n\n", result.target_id));
        md.push_str(&format!(
            "**Timestamp:** {}\n\n",
            result.timestamp.format("%Y-%m-%d %H:%M:%S UTC")
        ));
        md.push_str("**Metrics:**\n\n```json\n");
        md.push_str(
            &serde_json::to_string_pretty(&result.metrics).unwrap_or_else(|_| "{}".to_string()),
        );
        md.push_str("\n```\n\n");
    }

    // Footer
    md.push_str("---\n\n");
    md.push_str("*Generated by connector-hub-benchmarks*\n");

    md
}

/// Generate a summary table for quick overview.
pub fn generate_summary_table(results: &[BenchmarkResult]) -> String {
    let mut table = String::new();

    table.push_str("| # | Target ID | Status | Mean | Throughput |\n");
    table.push_str("|---|-----------|--------|------|------------|\n");

    for (i, result) in results.iter().enumerate() {
        let status = if result.is_success() { "OK" } else { "FAIL" };
        let mean = result
            .mean_ns()
            .map(|v| format_duration_ns(v))
            .unwrap_or_else(|| "-".to_string());
        let throughput = result
            .throughput()
            .map(|v| format!("{:.0} ops/s", v))
            .unwrap_or_else(|| "-".to_string());

        table.push_str(&format!(
            "| {} | {} | {} | {} | {} |\n",
            i + 1,
            result.target_id,
            status,
            mean,
            throughput
        ));
    }

    table
}

/// Format nanoseconds into a human-readable duration.
fn format_duration_ns(ns: u64) -> String {
    if ns < 1_000 {
        format!("{} ns", ns)
    } else if ns < 1_000_000 {
        format!("{:.2} us", ns as f64 / 1_000.0)
    } else if ns < 1_000_000_000 {
        format!("{:.2} ms", ns as f64 / 1_000_000.0)
    } else {
        format!("{:.2} s", ns as f64 / 1_000_000_000.0)
    }
}

#[cfg(test)]
mod tests {
    use super::*;
    use serde_json::json;

    #[test]
    fn test_generate_markdown_report() {
        let results = vec![
            BenchmarkResult::new(
                "test-1".to_string(),
                json!({"mean_ns": 1000, "p99_ns": 2000, "throughput": 500.0}),
            ),
            BenchmarkResult::new(
                "test-2".to_string(),
                json!({"mean_ns": 500, "p99_ns": 1000, "throughput": 1000.0}),
            ),
        ];

        let report = generate_markdown_report(&results, Some("Test Report"));
        assert!(report.contains("# Test Report"));
        assert!(report.contains("test-1"));
        assert!(report.contains("test-2"));
    }

    #[test]
    fn test_format_duration_ns() {
        assert_eq!(format_duration_ns(500), "500 ns");
        assert_eq!(format_duration_ns(5000), "5.00 us");
        assert_eq!(format_duration_ns(5_000_000), "5.00 ms");
        assert_eq!(format_duration_ns(5_000_000_000), "5.00 s");
    }
}
